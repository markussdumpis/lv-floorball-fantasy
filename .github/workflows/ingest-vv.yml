name: Ingest VV

on:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: services/lfs-ingest/package-lock.json

      - name: Install dependencies
        working-directory: services/lfs-ingest
        run: npm ci

      - name: Debug scripts
        working-directory: services/lfs-ingest
        run: |
          pwd
          ls -la
          cat package.json | sed -n '1,140p'
          npm run

      - name: Run ingest:matches
        working-directory: services/lfs-ingest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LFS_SKATERS_URL: ${{ secrets.LFS_SKATERS_URL }}
          LFS_GOALIES_URL: ${{ secrets.LFS_GOALIES_URL }}
          LFS_SKATERS_ENDPOINT: ${{ secrets.LFS_SKATERS_ENDPOINT }}
          LFS_SKATERS_FORM: ${{ secrets.LFS_SKATERS_FORM }}
          LFS_GOALIES_ENDPOINT: ${{ secrets.LFS_GOALIES_ENDPOINT }}
          LFS_GOALIES_FORM: ${{ secrets.LFS_GOALIES_FORM }}
          LFS_USER_AGENT: ${{ secrets.LFS_USER_AGENT }}
          LFS_COOKIE: ${{ secrets.LFS_COOKIE }}
        run: npm run ingest:matches

      - name: Sanity check: scheduled_in_past
        working-directory: services/lfs-ingest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node --input-type=module - <<'NODE'
          import { createClient } from '@supabase/supabase-js';

          const url = process.env.SUPABASE_URL;
          const key = process.env.SUPABASE_SERVICE_ROLE_KEY;
          const client = createClient(url, key);
          const nowIso = new Date().toISOString();

          const { count, error } = await client
            .from('matches')
            .select('id', { count: 'exact', head: true })
            .eq('season', '2025-26')
            .eq('status', 'scheduled')
            .lt('date', nowIso);

          if (error) {
            console.error('[sanity] query failed', error);
            process.exit(1);
          }

          const total = count ?? 0;
          console.log(`[sanity] scheduled_in_past=${total}`);

          if (total > 0) {
            const { data, error: rowsError } = await client
              .from('matches')
              .select('date, external_id, home_team, away_team')
              .eq('season', '2025-26')
              .eq('status', 'scheduled')
              .lt('date', nowIso)
              .order('date', { ascending: true })
              .limit(10);

            if (rowsError) {
              console.error('[sanity] fetch rows failed', rowsError);
              process.exit(1);
            }

            console.log('[sanity] top rows:', data);
            process.exit(1);
          }
          NODE

      - name: Run ingest:vv
        working-directory: services/lfs-ingest
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          LFS_SKATERS_URL: ${{ secrets.LFS_SKATERS_URL }}
          LFS_GOALIES_URL: ${{ secrets.LFS_GOALIES_URL }}
          LFS_SKATERS_ENDPOINT: ${{ secrets.LFS_SKATERS_ENDPOINT }}
          LFS_SKATERS_FORM: ${{ secrets.LFS_SKATERS_FORM }}
          LFS_GOALIES_ENDPOINT: ${{ secrets.LFS_GOALIES_ENDPOINT }}
          LFS_GOALIES_FORM: ${{ secrets.LFS_GOALIES_FORM }}
          LFS_USER_AGENT: ${{ secrets.LFS_USER_AGENT }}
          LFS_COOKIE: ${{ secrets.LFS_COOKIE }}
        run: npm run ingest:vv
